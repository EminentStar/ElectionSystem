<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/view/com/config.jsp"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<jsp:include page="/WEB-INF/view/com/meta.jsp" />
<jsp:include page="/WEB-INF/view/com/favicon.jsp" />
<jsp:include page="/WEB-INF/view/com/css.jsp" />
<jsp:include page="/WEB-INF/view/com/script.jsp" />
<title><c:out value = "${post.title}" /></title>
<script type="text/javascript">
	$(function() {

<c:choose>
	<c:when test="${crtCnt == 0}">
	//fail
	alert(validation.getMessage('msg.alert.error.general',['label.insert']));
	$("#title").val("${postParam.title}");
	$("#content").html("${postParam.content}");
	</c:when>
	<c:when test="${crtCnt == 1}">
	//success
	alert(validation.getMessage('msg.alert.complete.general',['label.insert']));
	window.location.href = vs.config.contextRoot +"/bbs/list";
	</c:when>
	<c:otherwise>
	
	//server side validation 실패
		
		<c:if test="${err != null}">
			$("#title").val("${postParam.title}");
			$("#content").html("${postParam.content}");
			var err = ${err};
			validation.showMessage(err.data.error,'td#label_');  //우리가 error라고 넣어놨으니깐 error라고 올거같습니다. 근데 제이슨형태로해야한다?
		</c:if>
				//toString()이 껍데기를 만들어줘서 data란게 생김!
	</c:otherwise>			
</c:choose>
	 	
		//-----------------------------------------------------------------------------------------------------
		$("#postForm").validate({
			rules : {
				title : {
					required : true,
					maxlength : 50
				},
				content : {
					required : true,
					maxlength : 1000
				}
			},
			messages : {
				title : {
					required : validation.getMessage("NotEmpty_general",["label_title"]),
					maxlength : validation.getMessage("Length_max_general",["label_title" , 50])
				},
				content : {
					required : validation.getMessage("NotEmpty_general",["label_content"]),
					maxlength : validation.getMessage("Length_max_general",["label_content" , 1000])
				}
			}
		});
		
		
		//-------------------------------------------------------------------------------------------------
	 		$("input[name=list]").bind('click',function(){
				window.location.href = "<spring:url value="/bbs/list" />"
				});
	//}); 
$("#update").bind('click',function(){
	
	if($("#postForm").valid()){
		//수정 ajax 수정은 PUT으로 날린다 url은 똑같이! 등록도 똑같이 할꺼다?뭔소리고?
		//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		$.ajax({
			url : '<spring:url value ="/bbs/detail/" />', // 이라인 지울것임 놔둬도되는데
			//왜지우냐? 
			data : $("#postForm").serialize(),
			type : 'PUT',
			success : function(data,textStatus,jqXHR){
				//삭제된 결과가 1이면 정상적으로 삭제되었으므로 메세지를 출력하고 리스트로 보낸다.
				var code = "msg_alert_complete_general";
				//삭제된 결과가 0이면 이미 삭제된 글이므로 메세지를 출력하고 리스트로 보낸다.
				if(data.updCnt == 0){
					code = "msg_alert_error_general";
				}
				alert(validation.getMessage(code,['label_update']));
				window.location.href = "<spring:url value="/bbs/list" />";
			},
			error : function(jqXHR,textStatus, errorThrown){
				alert(validation.getMessage('msg_alert_error_general'));										
				} 
			});	
		//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		}
	});

		//풋바 업바 인바
	//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
	$("#insert").bind('click',function(){
		 if($("#postForm").valid()){
			$("#postForm").submit();	
		} 
	});	
	//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@	
});
//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

//bbs.notice.title=제목
//bbs.notice.writerName
//csc.qna.content=내용
//label.list=목록
//label.remove=삭제
//label.update=수정
</script>
</head>
<body>
sss${userInfo.users_name}
	<form name="postForm" id="postForm"
	method="post"  
	enctype="multipart/form-data" 
	action = "<spring:url value ="/bbs/detail"/>" ><!-- 파일 업로드가 있으니 멀티파트로 할꺼다? 응씨발? ㅎㅎ뭔소리  -->
	
		<input type ="hidden" name ="num_bid" value="${post.num_bid}" />
		<input type="hidden" name="bbs_type" value="${post.bbs_tpye}" />
		<table border = "1" style="width:100%">	
			<tr>
				<td width ="20%" id = "label_title"><spring:message code="bbs.notice.title"/></td>
				<td><input type ="text" name ="title" id="title" value="<c:out value = "${post.title}"/> "/></td>
				<td width = "20%"><spring:message code="bbs.notice.writerName"/></td>
				<td width = "20%">
				<c:choose>
					<c:when test="${post == null} "><c:out value = "${userInfo.users_name}" /></c:when>
					<c:otherwise><c:out value="${post.users_name}" /></c:otherwise>
				</c:choose></td>
			</tr>
			
			<tr height = "500px">
				<td valign="top"  id = "label_content" ><spring:message code="csc.qna.content"/></td>
				<td valign="top" colspan="3"><textarea style="width:100%; height:100%;" id="content" name="content"><c:out value = "${post.content}" /></textarea></td>
			</tr>
			<tr>
				<td><spring:message code="bbs.notice.attach"/></td>
				<td colspan="3">
				<c:choose>
					<c:when test="${post != null}"><a href="<spring:url value="/file/download/${post.fid}" />"><c:out value="${post.filename}" /></a></c:when>
					<c:otherwise><input type = "file" name ="attachment" id="attachment" /></c:otherwise>
				</c:choose>
				</td>
				<%-- <a href="<spring:url value="/file/download/${post.fid}" />" ><c:out value = "${post.filename}" /></a></td> --%> 
				<!-- 가야할 주소는 file의 download메소드를호출하자 경로를 넘겨주어서?   -->
			</tr>
		</table>
		</form>
<div style ="text-align: right;height:30px;">
	<input type = "button" value = '<spring:message code="label.list" />' name = "list" />
	<c:choose>
		<c:when test="${post != null}">
			<input type="button" id ="update" name="update" value="<spring:message code="label.update" />" />
		</c:when>
		<c:otherwise>
			<input type="button" id ="insert" name="insert" value="<spring:message code="label.insert" />" />
		</c:otherwise>
	</c:choose>
</div>
</body>
</html>
